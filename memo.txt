CT评估系统开发记录：

肺部（/mnt/data2/model_evaluation/lung）

    测试数据路径：

        find_nodules:
        /mnt/data2/model_evaluation_test/test_data/find_nodules

            1000+结节病人测试数据：
                ./1000nodules
            医生标记：./anno
            模型预测框:./json

    老的测试结果路径：
    /mnt/data2/model_evaluation_test/test_result_old/lung/


        1000+结节病人测试结果：
        /mnt/data2/model_evaluation_test/test_result_old/lung/1000nodules

        310病人大测试集测试结果：
        /mnt/data2/model_evaluation_test/test_result_old/lung/test_gt

        错误的测试数据:
        /mnt/data2/model_evaluation_test/test_result_old/lung/wrong

    最新的测试结果路径：
    /mnt/data2/model_evaluation_test/test_result/lung

    新的测试结果路径:
    /mnt/data2/model_evaluation/excel_result

    find_nodules第一次测试结果：
        find_nodules_new:
        adjusted_rand_index: [0.92854375404774014]
        adjusted_mutual_info_score: [0.94211485954813834]
        normalized_mutual_info_score: [0.993732759001689]
        homogeneity_completeness_v_measure: [(0.99572566086389691, 0.99174384584639963, 0.99373076465223231)]
        fowlkes_mallows_score: [0.92893131414320906]



    find_nodules:
        adjusted_rand_index: [0.91913598562635535]
        adjusted_mutual_info_score: [0.92992787527280762]
        normalized_mutual_info_score: [0.99270861055585891]
        homogeneity_completeness_v_measure: [(0.99553672866136622, 0.98988852656078519, 0.99270459351689744)]
        fowlkes_mallows_score: [0.91975774001140587]

    cfda测试数据集：

        １．同一个结节存在多框嵌套的情况
        ２．结节某些层面框标得较歪或者形状不匹配
        ３．同一个结节出现了断层标记情况（所以z_threshold设为１对于这种情况肯定会分错）

    find_nodules接口输出：
        _, gt_df = get_nodule_stat():

       gt_df: type: pandas.DataFrame(columns=['Bndbox List', 'Nodule Id', 'Pid', 'Type', 'SliceRange', 'prob'])

       Bndbox List                                          Nodule Id
0     [[290.404144287, 278.346740723, 310.714599609,...        1.0
1     [[199.420593262, 237.297927856, 220.579101562,...        2.0
2     [[321.971069336, 279.845275879, 341.7003479, 2...        3.0
3     [[277.41696167, 252.18711853, 298.381988525, 2...        4.0
4     [[286.26361084, 236.98677063, 307.097106934, 2...        5.0
5     [[218.18486023, 234.080352783, 238.431442261, ...        6.0
6     [[268.388885498, 256.869750977, 288.909729004,...        7.0
7     [[178.420013428, 283.872406006, 198.702468872,...        8.0
8     [[196.083602905, 279.994567871, 215.941360474,...        9.0
9     [[329.26260376, 281.011169434, 349.633728027, ...       10.0
10    [[291.507965088, 276.301330566, 311.556427002,...       11.0
11    [[153.841217041, 260.624694824, 174.507736206,...       12.0
12    [[155.588531494, 272.645050049, 176.387588501,...       13.0
13    [[155.273117065, 279.350250244, 176.050308228,...       14.0
14    [[228.613739014, 247.436248779, 249.185653686,...       15.0
15    [[303.592926025, 303.719268799, 322.617858887,...       16.0
16    [[292.735900879, 223.234695435, 313.483184815,...       17.0
17    [[272.600585938, 277.286682129, 292.824005127,...       18.0
18    [[235.039382935, 239.985137939, 255.176757812,...       19.0
19    [[192.077087402, 261.891296387, 212.53515625, ...       20.0
20    [[217.81439209, 264.728271484, 237.56300354, 2...       21.0
21    [[325.640563965, 276.238891602, 346.218414307,...       22.0
22    [[148.604354858, 227.057312012, 170.82081604, ...       23.0
23    [[184.855239868, 217.105697632, 206.902694702,...       24.0
24    [[332.113464356, 271.242401123, 352.247344971,...       25.0
25    [[178.616073608, 211.675247192, 197.612182617,...       26.0
26    [[338.225463867, 243.555862427, 358.724151611,...       27.0
27    [[175.026885986, 231.431747436, 194.695755005,...       28.0
28    [[288.831085205, 215.532592773, 309.763763428,...       29.0
29    [[273.599273682, 271.522186279, 293.906738281,...       30.0
...                                                 ...        ...
3014  [[321.9949646, 302.508148193, 342.582397461, 3...     3015.0
3015  [[321.380859375, 292.951354981, 341.655761719,...     3016.0
3016  [[333.895141602, 283.430023193, 353.473480225,...     3017.0
3017  [[341.796173096, 309.272338867, 363.096343994,...     3018.0
3018  [[392.75, 274.823120117, 411.446899414, 293.55...     3019.0
3019  [[411.716186523, 251.686035156, 430.990661621,...     3020.0
3020  [[361.5027771, 298.587036133, 381.594787598, 3...     3021.0
3021  [[286.546386719, 266.113311768, 304.925354004,...     3022.0
3022  [[313.259246826, 289.384918213, 333.330780029,...     3023.0
3023  [[348.20236206, 283.161712647, 367.356140137, ...     3024.0
3024  [[182.661026001, 290.919616699, 202.541931152,...     3025.0
3025  [[111.424217224, 298.77810669, 131.944839478, ...     3026.0
3026  [[411.04977417, 249.460403442, 431.34060669, 2...     3027.0
3027  [[332.768890381, 293.510253906, 353.365264893,...     3028.0
3028  [[290.28503418, 280.438751221, 309.982666016, ...     3029.0
3029  [[138.778778076, 301.625366211, 160.490097046,...     3030.0
3030  [[311.508728027, 301.883239746, 333.566101074,...     3031.0
3031  [[307.993621826, 282.211151123, 328.804107666,...     3032.0
3032  [[281.98751831, 255.595962524, 302.637115478, ...     3033.0
3033  [[300.459350586, 276.25012207, 320.882904053, ...     3034.0
3034  [[374.209716797, 296.850646973, 393.957366943,...     3035.0
3035  [[182.767333984, 285.807189941, 205.01725769, ...     3036.0
3036  [[118.229431152, 300.736022949, 137.754013061,...     3037.0
3037  [[332.766876221, 300.941986084, 353.910430908,...     3038.0
3038  [[127.721862793, 303.58001709, 149.29951477, 3...     3039.0
3039  [[327.037841797, 297.430847168, 347.505767822,...     3040.0
3040  [[299.960906982, 279.822906494, 320.250640869,...     3041.0
3041  [[317.362304688, 297.488037109, 337.405975342,...     3042.0
3042  [[350.109069824, 306.80557251, 370.035247803, ...     3043.0
3043  [[393.860198975, 280.38973999, 414.098754883, ...     3044.0

          Pid             Type                      SliceRange                 prob
0     1000nodules  calcific nodule        [26, 27, 28, 29, 30, 31]  0.948676
1     1000nodules  calcific nodule                        [26, 27]  0.375400
2     1000nodules  calcific nodule                    [28, 29, 30]  0.996993
3     1000nodules        0-3nodule                        [28, 29]  0.681672
4     1000nodules        0-3nodule                        [31, 32]  0.969398
5     1000nodules        0-3nodule                            [31]  0.325808
6     1000nodules  calcific nodule                            [32]  0.336918
7     1000nodules        0-3nodule                        [32, 33]  0.898379
8     1000nodules        0-3nodule                    [34, 35, 36]  0.969434
9     1000nodules        0-3nodule                            [34]  0.122977
10    1000nodules     solid nodule        [35, 36, 37, 38, 39, 40]  0.999972
11    1000nodules        0-3nodule                            [35]  0.993045
12    1000nodules        0-3nodule                            [36]  0.992930
13    1000nodules        0-3nodule                    [37, 38, 39]  0.998735
14    1000nodules        0-3nodule                            [38]  0.946478
15    1000nodules     solid nodule                    [40, 41, 42]  0.760438
16    1000nodules        0-3nodule                            [43]  0.837521
17    1000nodules  calcific nodule                            [43]  0.334150
18    1000nodules  calcific nodule                        [44, 45]  0.997495
19    1000nodules        0-3nodule                        [44, 45]  0.797070
20    1000nodules        0-3nodule                        [44, 45]  0.964693
21    1000nodules        0-3nodule                            [44]  0.119984
22    1000nodules     solid nodule        [45, 46, 47, 48, 49, 50]  0.999193
23    1000nodules  calcific nodule                [45, 46, 47, 48]  0.908518
24    1000nodules        0-3nodule                        [45, 46]  0.352071
25    1000nodules        0-3nodule                        [46, 47]  0.811789
26    1000nodules        0-3nodule                            [46]  0.571877
27    1000nodules        0-3nodule                        [46, 47]  0.421123
28    1000nodules        0-3nodule                            [47]  0.999581
29    1000nodules        0-3nodule                            [47]  0.993994
...           ...              ...                             ...       ...
3014  1000nodules     solid nodule                      [232, 233]  0.478633
3015  1000nodules        0-3nodule                           [232]  0.123603
3016  1000nodules     solid nodule                      [233, 234]  0.984308
3017  1000nodules     solid nodule                 [234, 235, 236]  0.992408
3018  1000nodules     solid nodule       [234, 235, 236, 237, 238]  0.999896
3019  1000nodules  calcific nodule                 [234, 235, 236]  0.984653
3020  1000nodules  calcific nodule                           [234]  0.395093
3021  1000nodules  calcific nodule            [234, 235, 236, 237]  0.718001
3022  1000nodules     solid nodule                 [235, 236, 237]  0.910765
3023  1000nodules     solid nodule                      [235, 237]  0.664431
3024  1000nodules     solid nodule                           [235]  0.186468
3025  1000nodules        0-3nodule                           [235]  0.464161
3026  1000nodules  calcific nodule                      [236, 237]  0.984555
3027  1000nodules     solid nodule                           [236]  0.760964
3028  1000nodules     solid nodule                      [236, 238]  0.495697
3029  1000nodules     solid nodule                 [237, 238, 239]  0.879462
3030  1000nodules     solid nodule  [237, 238, 240, 241, 242, 243]  0.998876
3031  1000nodules     solid nodule                           [238]  0.980166
3032  1000nodules     solid nodule                      [238, 239]  0.611410
3033  1000nodules     solid nodule                 [239, 240, 241]  0.999556
3034  1000nodules     solid nodule                 [239, 240, 241]  0.997923
3035  1000nodules     solid nodule                 [239, 240, 241]  0.996796
3036  1000nodules     solid nodule                           [239]  0.214615
3037  1000nodules        0-3nodule                      [239, 240]  0.626936
3038  1000nodules        0-3nodule                      [241, 242]  0.899987
3039  1000nodules     solid nodule                 [244, 245, 246]  0.997734
3040  1000nodules     solid nodule                 [244, 245, 246]  0.973831
3041  1000nodules     solid nodule                           [248]  0.135523
3042  1000nodules        0-3nodule                      [248, 249]  0.988717
3043  1000nodules     solid nodule                      [249, 250]  0.999252







    find_nodules测试结果分析：
        ground truth label:
        代码运行指令：默认目录为/mnt/data2/model_evaluation
        聚类统计：
        python -m lung.find_nodules_test --gt_anno_dir /mnt/data2/model_evaluation_test/test_data/find_nodules/0801_lulin_review/anno --clustering_test
        结节数量统计：
        python -m lung.find_nodules_test --gt_anno_dir /mnt/data2/model_evaluation_test/test_data/find_nodules/0801_lulin_review/anno

        路径：/mnt/data2/model_evaluation_test/test_result/lung/find_nodules

            cfda紧密包裹标记数据集

                结节数量统计测试结果：
                ./find_nodules_nodule_count_test.ods

                聚类统计测试结果：
                ./FindNodulesEvaluation_find_nodules_new_z_threshold=2_0.9_clustering_test.xlsx
                ./FindNodulesEvaluation_find_nodules_z_threshold=1_0.2_clustering_test.xlsx

            1000结节病人数据：

                结节数量/聚类统计测试结果：
                ./FindNodulesEvaluation_find_nodules_1000nodules_clustering_test.xlsx

            结论：
            １、总体来讲，find_nodules以及find_nodules_new对于ground truth label的效果差异不大，这从理论上是比较好理解的，因为对于ground truth label,
            我们首先是不做同层面框的等价类合并的，因为我们默认医生每标一个框就应该是一个独立的结节。其次，ground truth默认概率都是1，所以我们新算法中对于
            结节概率的操作也没有得到测试和检验。另外目前测试的cfda和1000结节数据一个是没有类别，一个仅有0-3和solid nodule,对于新算法中对于结节种类的
            操作的检验也有限。最后，原则上医生标注时是不会断层标记的，所以z_threshold默认＝１最好，这也进一步降低了ground truth测试问题的复杂度。
            ２、对于cfda数据，通过结节数量统计出的最优阈值为：
                a. find_nodules: score_threshold = 0.2, z_threshold = 1, 总结节数517/517，分对的病人数18/22
                b. find_nodules_new:　score_threshold = 1., z_thredshold = 1,2, 总结节数521/517, 512/517,分对的病人数19/22
                注：这里的阈值偏松是因为cfda这套数据结节比较稀疏，很少存在聚在一起的结节，所以判定是一个结节的阈值松一点并不容易错误地把两个结节连成一个，
                但更容易把层面间偏移量较大的同一个结节的框匹配在一起。
                进一步聚类测试发现，find_nodules最优阈值情况下的结果还要略好于find_nodules_new，所以总体而言对于cfda数据两个算法差异很小
            ３、对于1000结节病人数据，通过聚类和结节数量统计出的最优阈值为：
                a. find_nodules: score_threshold = 0.75,　z_threshold = 1, 总结节数749/736
                b. find_nodules_new: score_threshold = 0.4, 0.35, z_threshold = 1,　2, 总结节数745/736, 753/736, 736/736, 744/736
                注：这里的最优阈值就明显更严，主要是因为这套数据是多发结节，有很多框重合在一起，所以阈值严一点才不容易把两个结节连成一个，但同时有可能
                会牺牲一些层面间偏移量较大的结节，认为是多个。所以总的来讲，聚类的效果没有cfda数据集好。find_nodules_new与find_nodules相比
                聚类效果更优一些，但不是很显著(<1%)
            ４、结论是，对于ground truth label的复杂度较低的结节匹配问题，find_nodules和find_nodules_new的算法总体差异不大，find_nodules_new可能有少量的
                提升。相比之下，score_threshold，z_threshold等超参数对于匹配效果的影响要显著的多，而且不同的数据、标记风格所对应的最优参数会
                差别很大，所以如何选择最优化的参数及算法需要进一步的研究和证明。目前可以确定的是对于正常标记的数据（几乎没有断层）,z_threshold=1最好

        pred label:
        注：模型预测结果是以扫描层面为单位的一系列2D的框，并带有多分类、softmax置信度阈值等信息，并且会有假阳的存在，是相比ground truth label复杂度要
        高很多的问题。原先设想的是让医生主观选取和匹配２D的框，再与find_nodules输出的结果进行比对。但与大哥商量之后，初步的测试方案为：
        １、对比两种方式输出的结节数量：一种为先用一定阈值筛选框，再匹配成结节；另一种为先匹配成结节，再根据结节概率的最大层面来进行阈值筛选，对比这两种操作
        的结果差异。2018/8/5之前完成。